!-----------------------------------------------------------------------------------------------!
SUBROUTINE SIP(R,SLC,ALFA,LBOUN,NX,NY,ITMAX,ILIM,IOUT) 
!-----------------------------------------------------------------------------------------------!
IMPLICIT DOUBLE PRECISION (A-H,O-Z)
!-----------------------------------------------------------------------------------------------!
PARAMETER(NDIM=150)
!-----------------------------------------------------------------------------------------------!
COMMON /COOR/ X(0:NDIM+1,0:NDIM+1),Y(0:NDIM+1,0:NDIM+1)
COMMON /FORCE/ RXI(NDIM,NDIM), RETA(NDIM,NDIM)
!-----------------------------------------------------------------------------------------------!
DIMENSION R(12),LBOUN(4)
DIMENSION AP(NDIM,NDIM),AR(NDIM,NDIM),B(NDIM,NDIM)
DIMENSION CX(NDIM,NDIM),CY(NDIM,NDIM)
!-----------------------------------------------------------------------------------------------!
ONE=1.D0
NXM1=NX-1
NYM1=NY-1
!-----------------------------------------------------------------------------------------------!
DO I=1,NX,NXM1
   DO J=1,NY
      AP(J,I)=0.D0
      AR(J,I)=0.D0
       B(J,I)=0.D0
      CX(J,I)=0.D0
      CY(J,I)=0.D0
   END DO !J=1,NY
END DO !I=1,NX,NXM1
!-----------------------------------------------------------------------------------------------!
DO J=1,NY,NYM1
   DO I=1,NX
      AP(J,I)=1.D0
      AR(J,I)=0.D0
       B(J,I)=0.D0
      CX(J,I)=0.D0
      CY(J,I)=0.D0
   END DO !I=1,NX
END DO !J=1,NY,NYM1
!-----------------------------------------------------------------------------------------------!
!!WRITE(6,1000)
!-----------------------------------------------------------------------------------------------!
IF (ILIM >= 0) CALL RHS(R(12),ALFA,LBOUN,NX,NY,0)
DIFOLD=10000
IRHS=0
!-----------------------------------------------------------------------------------------------!
DO IT=1,ITMAX
!-----------------------------------------------------------------------------------------------!
   IF ((ILIM > 0).AND.(IRHS == 0)) THEN 
      CALL RHS(R(12),ALFA,LBOUN,NX,NY,1)
   ELSE
      IRHS=IRHS+1
   END IF
!-----------------------------------------------------------------------------------------------!
   DO IR=4,11
      R(IR)=0.D0
   END DO !IR=4,11
!-----------------------------------------------------------------------------------------------!
!    Condensation                                                                               !
!-----------------------------------------------------------------------------------------------!
   DO I=NXM1,2,-1
      IP1=I+1
      IM1=I-1
      DO J=NYM1,2,-1
         JP1=J+1
         JM1=J-1
!-----------------------------------------------------------------------------------------------!
         DXDKS=0.5D0*(X(J,IP1)-X(J,IM1))
         DYDKS=0.5D0*(Y(J,IP1)-Y(J,IM1))
         DXDET=0.5D0*(X(JP1,I)-X(JM1,I))
         DYDET=0.5D0*(Y(JP1,I)-Y(JM1,I))
!-----------------------------------------------------------------------------------------------!
         G11= DXDET*DXDET+DYDET*DYDET
         G12=-DYDET*DYDKS-DXDET*DXDKS
         G22= DXDKS*DXDKS+DYDKS*DYDKS
!-----------------------------------------------------------------------------------------------!
         ARXI =DABS(RXI(J,I))
         ARETA=DABS(RETA(J,I))
         AXI  =MIN(ONE,0.5D0*ARXI)
         AETA =MIN(ONE,0.5D0*ARETA)
         CFXI =AXI*ARXI
         CFETA=AETA*ARETA
!-----------------------------------------------------------------------------------------------!
         QJI  =-G11*(2.D0+CFXI)-G22*(2.D0+CFETA)
         PPJI = 0.5D0*G22*(2.0+CFETA-RETA(J,I))
         SJI  = 0.5D0*G11*(2.0+CFXI-RXI(J,I))
         RJI  = 0.5D0*G22*(2.0+CFETA+RETA(J,I)) 
         TJI  = 0.5D0*G11*(2.0+CFXI+RXI(J,I))
         ZZXJI= 0.5D0*G12*(X(JP1,IP1)+X(JM1,IM1)-X(JP1,IM1)-X(JM1,IP1))
         ZZYJI= 0.5D0*G12*(Y(JP1,IP1)+Y(JM1,IM1)-Y(JP1,IM1)-Y(JM1,IP1))
!-----------------------------------------------------------------------------------------------!
         R0XJI=PPJI*X(JM1,I)+QJI*X(J,I)+SJI*X(J,IM1)+RJI*X(JP1,I)+TJI*X(J,IP1)+ZZXJI
         R0YJI=PPJI*Y(JM1,I)+QJI*Y(J,I)+SJI*Y(J,IM1)+RJI*Y(JP1,I)+TJI*Y(J,IP1)+ZZYJI
!-----------------------------------------------------------------------------------------------!
         QJI  =(1.D0+SLC)*QJI
         QINV =1.D0/QJI
         PPJI =QINV*PPJI
         RJI  =QINV*RJI
         TJI  =QINV*TJI
         SJI  =QINV*SJI
         QJI  =1.D0
         R0XJI=QINV*R0XJI
         R0YJI=QINV*R0YJI
!-----------------------------------------------------------------------------------------------!
         RESX =DABS(R0XJI)
         R(8) =MAX(R(8),RESX)
         R(10)=R(10)+RESX
         RESY =DABS(R0YJI)
         R(9) =MAX(R(9),RESY)
         R(11)=R(11)+RESY
!-----------------------------------------------------------------------------------------------!
         QJI  =QJI+TJI*B(J,IP1)
         R0XJI=R0XJI+TJI*CX(J,IP1)
         R0YJI=R0YJI+TJI*CY(J,IP1)
!-----------------------------------------------------------------------------------------------!
         QINV   = 1.D0/QJI              
         AP(J,I)= QINV*PPJI
         AR(J,I)= QINV*RJI
         B(J,I) =-QINV*SJI
         CX(J,I)=-QINV*R0XJI
         CY(J,I)=-QINV*R0YJI
!-----------------------------------------------------------------------------------------------!
      END DO !J=NYM1,2,-1
   END DO !I=NXM1,2,-1
!-----------------------------------------------------------------------------------------------!
   DO I=2,NXM1
      IM1=I-1
      DO J=2,NYM1
         CX(J,I)=B(J,I)*CX(J,IM1)+CX(J,I)
         CY(J,I)=B(J,I)*CY(J,IM1)+CY(J,I)
      END DO !J=2,NYM1
!-----------------------------------------------------------------------------------------------!
      DO J=2,NYM1
         JM1=J-1
         DIV=AP(J,I)/AP(JM1,I)
         AP(J,I)=ONE-DIV*AR(JM1,I)
         CX(J,I)=CX(J,I)-DIV*CX(JM1,I)
         CY(J,I)=CY(J,I)-DIV*CY(JM1,I)
      END DO !J=2,NYM1
!-----------------------------------------------------------------------------------------------!
      DO J=NYM1,2,-1
         JP1=J+1
         CX(J,I)=(CX(J,I)-AR(J,I)*CX(JP1,I))/AP(J,I)
         CY(J,I)=(CY(J,I)-AR(J,I)*CY(JP1,I))/AP(J,I)
         ACX=DABS(CX(J,I))
         R(4)=MAX(R(4),ACX)
         R(6)=R(6)+ACX
         ACY=DABS(CY(J,I))
         R(5)=MAX(R(5),ACY)
         R(7)=R(7)+ACY
      END DO !J=NYM1,2,-1
   END DO !I=2,NXM1
!-----------------------------------------------------------------------------------------------!
   ICONV=0
   IF ((IRHS == 0).AND.(R(4) < R(1)).AND.(R(5) < R(2))) ICONV=1
!! IF ((IOUT /= 0).OR.(IT == 1).OR.(IT == ITMAX).OR.(ICONV == 1)) &
!!                                                              WRITE(6,1100) IT,(R(IR),IR=4,12)
   IF(ICONV.EQ.1) GOTO 160
!-----------------------------------------------------------------------------------------------!
   DIFOLD=R(4)*R(5)
   IF ((DIFOLD <= 5.D-8).AND.(IRHS == 0)) IRHS=1
   IF (IRHS == 5) IRHS=0
!-----------------------------------------------------------------------------------------------!
   DO I=2,NXM1
      DO J=2,NYM1
         X(J,I)=X(J,I)+R(3)*CX(J,I)
         Y(J,I)=Y(J,I)+R(3)*CY(J,I)
      END DO !J=2,NYM1
   END DO !I=2,NXM1
   DO 140 IL=1,4
      IF (LBOUN(IL) == 0) GOTO 140
      CALL CALCB(IL,LBOUN(IL),NX,NY)
   140 CONTINUE !IL=1,4
END DO !IT=1,ITMAX
!-----------------------------------------------------------------------------------------------!
160 RETURN
!-----------------------------------------------------------------------------------------------!
1000 FORMAT(//,'  I     DX      DY      DXT     DYT     RESX    RESY    RESXT   RESYT    DFI',/)
1100 FORMAT(I5,9(1PE8.1))
!-----------------------------------------------------------------------------------------------!
END SUBROUTINE SIP
!-----------------------------------------------------------------------------------------------!
